#! /usr/bin/env python

import os
import sys
import itertools

import numpy as np
import nibabel as nib
from time import time

from dipy.fixes import argparse

from dipy.segment.clustering import outlier_rejection


def build_args_parser():
    description = "Detect tractography outliers in a tractogram."
    p = argparse.ArgumentParser(description=description)

    p.add_argument("tractogram", help="File containing streamlines (.trk).")

    p.add_argument("--threshold", type=float, default=0,
                   help="Reject streamlines having an outlierness score above this threshold (%%)."
                        "Default: set manually through an interactive display.")

    p.add_argument("--inliers", help="Filename where to save tractography intliers (.trk)."
                   "Default: append '_inliers' to the tractogram filename")
    p.add_argument("--outliers", help="Filename where to save tractography outliers (.trk)."
                   "Default: append '_outliers' to the tractogram filename")
    p.add_argument("--outlierness", help="Filename where to save the outlierness scores (.csv).")

    p.add_argument("--confidence_level", type=float, default=0.95,
                   help="Confidence level controlling the number of orderings. Default: 0.95")

    p.add_argument("--seed", type=int, default=1234, help="Seed used to shuffle orderings. Default: 1234")
    p.add_argument('-v', "--verbose", action="store_true",
                   help="Enable verbose mode.")

    return p

class Timer():
    def __init__(self, txt):
        self.txt = txt

    def __enter__(self):
        self.start = time()
        print self.txt + "... ",
        sys.stdout.flush()

    def __exit__(self, type, value, tb):
        print "{:.2f} sec.".format(time()-self.start)


def load_tractogram(filename):
    streams, hdr = nib.trackvis.read(filename)
    streamlines, colors, properties = zip(*streams)
    return streamlines, colors, properties, hdr


def save_tractogram(filename, streamlines, colors, properties, hdr):
    data = itertools.izip_longest(streamlines, colors, properties)
    nib.trackvis.write(filename.split(".trk")[0] + ".trk", data, hdr)


def append_text_to_filename(filename, text):
    path, ext = os.path.splitext(filename)
    return path + text + ext


def create_hist_actor(data, colormap_name="jet"):
    import vtk
    from dipy.viz import actor, utils

    import pylab as plt
    if not hasattr(plt, 'style'):
        print "Use Matplotlib >= 1.4 to have better colormap."
    else:
        plt.style.use('dark_background')

    # Make histogram plot prettier.
    plt.rcParams['font.size'] = 24
    #plt.rcParams['font.weight'] = "bold"
    fig = plt.figure(dpi=300)
    ax = fig.add_subplot(111)
    ax.set_title('Outlierness', fontsize="32", fontweight="bold")
    n, bins, patches = ax.hist(data, bins=np.linspace(0, 1, 101), linewidth=0)

    # Apply colormap to histogram.
    cm = plt.cm.get_cmap(colormap_name)
    bin_centers = 0.5 * (bins[:-1] + bins[1:])
    # scale values to interval [0,1]
    col = bin_centers - min(bin_centers)
    col /= max(col)

    for c, p in zip(col, patches):
        plt.setp(p, 'facecolor', cm(c))

    ax.spines['right'].set_visible(False)
    ax.spines['top'].set_visible(False)
    ax.xaxis.set_ticks_position('bottom')
    ax.yaxis.set_ticks_position('left')

    arr = utils.matplotlib_figure_to_numpy(fig, dpi=300, transparent=False)
    plt.close(fig)
    figure_actor = actor.figure(arr, size=100, interpolation='linear')

    # Make sure the figure is center is in the middle of the image.
    transform = vtk.vtkTransform()
    transform.Translate(-np.array(figure_actor.GetCenter()))
    figure_actor.SetUserMatrix(transform.GetMatrix())
    return figure_actor


def set_threshold_manually(streamlines, outlierness):
    import vtk
    from dipy.viz import fvtk, actor, window
    colormap_name = "jet"
    stream_actor = actor.line(streamlines, colors=fvtk.create_colormap(outlierness, name=colormap_name))
    stream_actor.SetPosition(-np.array(stream_actor.GetCenter()))

    global threshold
    threshold = 0.4

    streamlines_color = np.zeros(len(streamlines), dtype="float32")
    streamlines_color[outlierness < threshold] = 1
    streamlines_color[outlierness >= threshold] = 0

    lut = vtk.vtkLookupTable()
    lut.SetNumberOfTableValues(2)
    lut.Build()
    lut.SetTableValue(0, tuple(fvtk.colors.orange_red) + (1,))
    lut.SetTableValue(1, tuple(fvtk.colors.green) + (1,))
    lut.SetTableRange(0, 1)

    stream_split_actor = actor.line(streamlines, colors=streamlines_color, lookup_colormap=lut)
    #stream_split_actor = actor.line(streamlines, colors=fvtk.create_colormap(outlierness, name=colormap_name))
    stream_split_actor.SetPosition(-np.array(stream_split_actor.GetCenter()))
    hist_actor = create_hist_actor(outlierness, colormap_name=colormap_name)


    bg = (0, 0, 0)
    global screen_size
    default_ren = window.Renderer()
    default_ren.background(bg)
    show_m = window.ShowManager(default_ren, size=(1200, 900), interactor_style="trackball")
    screen_size = show_m.iren.GetSize()

    ren = window.Renderer()
    show_m.window.AddRenderer(ren)
    ren.background(bg)
    ren.SetViewport(0, 0, 0.7, 1)
    ren.add(stream_split_actor)
    ren.reset_camera_tight()

    # Create another renderer for the histogram
    ren_hist = window.Renderer()
    show_m.window.AddRenderer(ren_hist)
    ren_hist.projection("parallel")
    ren_hist.background(bg)
    ren_hist.SetViewport(0.7, 0.6, 1, 1)
    ren_hist.add(hist_actor)
    ren_hist.reset_camera_tight(margin_factor=0.85)
    ren_hist.SetInteractive(False)

    # Create another renderer for the threshold slider
    ren_threshold = window.Renderer()
    show_m.window.AddRenderer(ren_threshold)
    ren_threshold.background(bg)
    ren_threshold.SetViewport(0.7, 0.4, 1, 0.6)

    def apply_threshold(obj, evt):
        global threshold
        new_threshold = np.round(obj.GetSliderRepresentation().GetValue(), decimals=2)
        obj.GetSliderRepresentation().SetValue(new_threshold)
        if threshold != new_threshold:
            threshold = new_threshold

            # with Timer("indexing"):
            #     streamlines_color = np.zeros((len(streamlines), 3))
            #     streamlines_color[outlierness < threshold] = fvtk.colors.green
            #     streamlines_color[outlierness >= threshold] = fvtk.colors.orange_red

            # with Timer("coloring"):
            #     colors = []
            #     for color, streamline in zip(streamlines_color, streamlines):
            #         colors += [np.array(255 * color, dtype="uint8")] * len(streamline)

            # with Timer("acting1"):
            #     vtk_colors = actor.numpy_to_vtk_colors(255 * np.array(colors))
            #     vtk_colors.SetName("Colors")
            #     stream_split_actor.GetMapper().GetInput().GetPointData().SetScalars(vtk_colors)

            with Timer("indexing"):
                streamlines_color = np.zeros(len(streamlines), dtype=np.float32)
                streamlines_color[outlierness < threshold] = 1
                streamlines_color[outlierness >= threshold] = 0

            with Timer("coloring"):
                colors = []
                for color, streamline in zip(streamlines_color, streamlines):
                    colors += [color] * len(streamline)

            with Timer("acting"):
                scalars = stream_split_actor.GetMapper().GetInput().GetPointData().GetScalars()
                for i, c in enumerate(colors):
                    scalars.SetValue(i, c)

                scalars.Modified()

    threshold_slider_rep = vtk.vtkSliderRepresentation3D()
    threshold_slider_rep.SetMinimumValue(0.)
    threshold_slider_rep.SetMaximumValue(1.)
    threshold_slider_rep.SetValue(threshold)
    threshold_slider_rep.SetTitleText("Threshold")
    threshold_slider_rep.SetTitleHeight(0.05)
    threshold_slider_rep.SetLabelFormat("%0.2lf")
    threshold_slider_rep.SetLabelHeight(0.05)
    threshold_slider_rep.GetPoint1Coordinate().SetCoordinateSystemToWorld()
    threshold_slider_rep.GetPoint1Coordinate().SetValue(-10, 0, 0)
    threshold_slider_rep.GetPoint2Coordinate().SetCoordinateSystemToWorld()
    threshold_slider_rep.GetPoint2Coordinate().SetValue(10, 0, 0)
    threshold_slider_rep.SetSliderLength(0.075)
    threshold_slider_rep.SetSliderWidth(0.05)
    threshold_slider_rep.SetEndCapLength(0.05)

    threshold_slider = vtk.vtkSliderWidget()
    threshold_slider.SetInteractor(show_m.iren)
    threshold_slider.SetRepresentation(threshold_slider_rep)
    threshold_slider.SetCurrentRenderer(ren_threshold)
    threshold_slider.SetAnimationModeToAnimate()
    threshold_slider.SetNumberOfAnimationSteps(100)
    threshold_slider.EnabledOn()

    threshold_slider.AddObserver("InteractionEvent", apply_threshold)

    ren_threshold.add(threshold_slider_rep)
    ren_threshold.reset_camera_tight(margin_factor=0.85)
    ren_threshold.SetInteractive(False)

    # Create another renderer for the outlierness
    ren_outlierness = window.Renderer()
    show_m.window.AddRenderer(ren_outlierness)
    ren_outlierness.background(bg)
    ren_outlierness.SetViewport(0.7, 0, 1, 0.4)
    ren_outlierness.add(stream_actor)
    ren_outlierness.reset_camera_tight(margin_factor=0.8)

    def _window_callback(obj, event):
        global screen_size
        if screen_size != obj.GetSize():
            ren_hist.reset_camera_tight()
            screen_size = obj.GetSize()

    show_m.add_window_callback(_window_callback)
    show_m.initialize()
    show_m.render()
    show_m.start()

    inliers = [s for s, keep in zip(streamlines, outlierness < threshold) if keep]
    outliers = [s for s, keep in zip(streamlines, outlierness >= threshold) if keep]
    return inliers, outliers


def main():
    parser = build_args_parser()
    args = parser.parse_args()

    streamlines, colors, properties, hdr = load_tractogram(args.tractogram)

    inliers, outliers, outlierness = outlier_rejection(streamlines, threshold=args.threshold,
                                                       confidence=args.confidence_level, seed=args.seed,
                                                       return_outlierness=True, verbose=args.verbose)

    if args.threshold == 0.:
        inliers, outliers = set_threshold_manually(streamlines, outlierness)

    # Save results
    if args.outlierness is not None:
        np.savetxt(args.outlierness.split(".csv")[0] + ".csv", outlierness, delimiter=",")

    inliers_filename = args.inliers
    if args.inliers is None:
        inliers_filename = append_text_to_filename(args.tractogram, "_inliers")

    save_tractogram(inliers_filename, inliers, [], [], hdr)

    outliers_filename = args.outliers
    if args.outliers is None:
        outliers_filename = append_text_to_filename(args.tractogram, "_outliers")

    save_tractogram(outliers_filename, outliers, [], [], hdr)


if __name__ == "__main__":
    main()
